<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Yaar artifactory browser</title>

    <script>
        var apiPrefix = "/api/v1/meta";
        var sortBy = "Time";
        var ascending = false;
        var maxNameLen = 0;

        function formatLocks(locks) {
            return (locks && locks.length) ? locks.join('; ') : '-';
        }

        function formatTags(tags) {
            return formatLocks(tags);
        }

        function addItemToFileList(tableBody, name, href, isDir, size, modTime, expiry, locks, tags) {
            if (isDir) name += '/';
            const row = document.createElement('tr');

            const nameCell = document.createElement('td');
            const entryLink = document.createElement('a');
            entryLink.href = href;
            entryLink.textContent = name;
            nameCell.appendChild(entryLink);
            row.appendChild(nameCell);

            const groupNumber = (num) => {
                // vibe-coded, does "1234567" -> "1'234'567"
                return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, "'");
            }

            const appendCell = (content) => {
                const cell = document.createElement('td');
                cell.textContent = content;
                row.appendChild(cell);
            };

            if (name !== "../") {
                appendCell(formatDate(new Date(modTime * 1000)));
                appendCell(groupNumber(size));
                appendCell(expiry ? formatDate(new Date(expiry * 1000)) : '-');
                appendCell(formatLocks(locks));
                appendCell(formatTags(tags));
            }

            tableBody.appendChild(row);
        }

        function processEntry(tableBody, entry) {
            var href = entry.IsDir ? '#' + entry.FullPath : entry.Url;
            addItemToFileList(tableBody, entry.Name, href, entry.IsDir, entry.Size, entry.ModTime, entry.ExpiryTime, entry.Locks, entry.Tags);
        }

        function processEntries(filelist) {
            const table = document.getElementById('filelist');
            const tableBody = table.querySelector('tbody');

            mkTitle = function(label) {
                let ind = '';
                if (label === sortBy) {
                    ind = ascending ? '▲' : '▼';
                }
                return `<a href="#" onclick="changeSort(event, '${label}')">${label}${ind}</a>`;
            };

            var cmp = (a, b) => (a.Name < b.Name ? -1 : 1);
            switch (sortBy) {
                case "Name": cmp = (a, b) => (a.Name < b.Name ? -1 : 1); break;
                case "Time": cmp = (a, b) => (a.ModTime < b.ModTime ? -1 : 1); break;
                case "Size": cmp = (a, b) => (a.Size < b.Size ? -1 : 1); break;
                case "Expiry": cmp = (a, b) => (a.ExpiryTime < b.ExpiryTime ? -1 : 1); break;
                case "Locks": cmp = (a, b) => (formatLocks(a.Locks) < formatLocks(b.Locks) ? -1 : 1); break;
                case "Tags": cmp = (a, b) => (formatTags(a.Tags) < formatTags(b.Tags) ? -1 : 1); break;
            }
            filelist.sort(cmp);
            if (!ascending) filelist.reverse();
            filelist.sort((a, b) => a.IsDir == b.IsDir ? 0 : b.IsDir - a.IsDir);

            maxNameLen = 50;
            for (const d of filelist) {
                maxNameLen = Math.max(d.Name.length+1, maxNameLen);
            }

            // Clear previous content + add header
            tableBody.innerHTML = '';
            const headerRow = document.createElement('tr');

            const appendHeader = (title) => {
                const header = document.createElement("th");
                header.innerHTML = mkTitle(title);
                headerRow.appendChild(header);
            };

            appendHeader("Name");
            appendHeader("Time");
            appendHeader("Size");
            appendHeader("Expiry");
            appendHeader("Locks");
            appendHeader("Tags");


            tableBody.appendChild(headerRow);

            let fragment = window.location.hash.substr(1);
            if (fragment) {
                let up = fragment.substring(0, fragment.lastIndexOf('/'));
                addItemToFileList(tableBody, '..', '#' + up, true, 0, 0, 0, [], []);
            }

            for (const d of filelist) {
                processEntry(tableBody, d);
            }
        }

        function fetchDirectory(path) {

            fetch(apiPrefix + path, {
                method: 'GET',
                headers: { 'Accept': 'application/json' },
            }).then(response => {
                if (!response.ok) {
                    throw new Error('Network error');
                }
                return response.json();
            }).then(data => {
                document.title = path + '/ - yaar';
                document.getElementById('dirname').innerText = path + '/';
                document.getElementById('querytime').innerText = formatDate(new Date());
                processEntries(data);
            }).catch(error => {
                console.error('Error fetching content:', error);
                document.getElementById('filelist').innerHTML = 'Error fetching content';
            });
        }

        // Function to handle navigation using fragment
        function handleFragmentNavigation() {
            var fragment = window.location.hash.substr(1); // Remove '#' from the fragment
            fetchDirectory(fragment);
        }

        function changeSort(event, newSort) {
            event.preventDefault();
            if (newSort === sortBy) {
                ascending = !ascending;
            } else {
                sortBy = newSort;
                ascending = true;
            }
            handleFragmentNavigation();
        }

        window.onhashchange = function () {
            handleFragmentNavigation();
        };
    </script>
    <style>
        table {
            border-collapse: collapse;
        }
        th, td {
            padding-left: 8px;
            padding-right: 8px;
        }
        th {
            min-width: 100px;
            text-align: left;
        }
        td:nth-child(3) {
            text-align: right;
            padding-right: 24px;
        }
        td:nth-child(1) {
            min-width: 300px;
        }
    </style>
</head>

<body>
    <h1 id="dirname">/xxx</h1>
    <hr>
    <table id="filelist">
        <tbody>
        </tbody>
    </table>
    <hr>
    <pre id="querytime"></pre>

    <script>
        // Fetch initial content when the page loads
        document.addEventListener('DOMContentLoaded', function () {
            handleFragmentNavigation();
        });

        function formatDate(date) {
            return date.getFullYear() + '-' +
                String(date.getMonth() + 1).padStart(2, '0') + '-' +
                String(date.getDate()).padStart(2, '0') + ' ' +
                String(date.getHours()).padStart(2, '0') + ':' +
                String(date.getMinutes()).padStart(2, '0') + ':' +
                String(date.getSeconds()).padStart(2, '0');
        }
    </script>
</body>
</html>
